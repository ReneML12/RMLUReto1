name: Generar reporte de repos + ramas importantes (CSV → XLSX)

on:
  workflow_dispatch:

jobs:
  list:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.PAT_TOKEN }}
      LONG_LIVED_BRANCHES: "main QA develop"
    steps:
      - name: Instalar Go y csv2xlsx
        run: |
          # Instalar csv2xlsx desde el repo
          go install github.com/mentax/csv2xlsx@latest
          # Añadir binarios de Go al PATH
          echo "PATH desde Go: $(go env GOPATH)/bin"
          export PATH="$PATH:$(go env GOPATH)/bin"
          # Verificar que csv2xlsx esté instalado
          csv2xlsx -h

      - name: Obtener todos los repositorios
        run: |
          curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/user/repos?per_page=100" > repos.json

      - name: Iniciar CSV
        run: |
          echo "repo,main,QA,develop" > branches_report.csv

      - name: Verificar ramas por repo y llenar CSV
        run: |
          for repo in $(jq -r '.[].full_name' repos.json); do
            branches=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$repo/branches?per_page=100" \
              | jq -r '.[].name')
            has_main=""
            has_QA=""
            has_develop=""
            if echo "$branches" | grep -xq "main"; then has_main="yes"; fi
            if echo "$branches" | grep -xq "QA"; then has_QA="yes"; fi
            if echo "$branches" | grep -xq "develop"; then has_develop="yes"; fi
            echo "\"$repo\",\"$has_main\",\"$has_QA\",\"$has_develop\"" >> branches_report.csv
          done

      - name: Convertir CSV a XLSX
        run: |
          csv2xlsx -o branches_report.xlsx branches_report.csv

      - name: Subir reporte XLSX como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: branches-report-xlsx
          path: branches_report.xlsx
