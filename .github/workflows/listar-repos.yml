name: Generar reporte de repos + ramas importantes (CSV → XLSX)

on:
  workflow_dispatch:

jobs:
  list:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.PAT_TOKEN }}
      LONG_LIVED_BRANCHES: "main QA develop"
    steps:
      - name: Instalar csv2xlsx y generar reporte
        run: |
          # Instala csv2xlsx desde Go
          go install github.com/mentax/csv2xlsx@latest
          export PATH="$PATH:$(go env GOPATH)/bin"
          # Verifica que el binario existe
          csv2xlsx -h || (echo "csv2xlsx no se instaló correctamente" && exit 1)

          # Obtener todos los repositorios
          curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/user/repos?per_page=100" > repos.json

          # Crear CSV
          echo "repo,main,QA,develop" > branches_report.csv

          # Llenar CSV con presencia de ramas
          for repo in $(jq -r '.[].full_name' repos.json); do
            branches=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$repo/branches?per_page=100" \
              | jq -r '.[].name')
            has_main=""
            has_QA=""
            has_develop=""
            if echo "$branches" | grep -xq "main"; then has_main="si"; fi
            if echo "$branches" | grep -xq "QA"; then has_QA="si"; fi
            if echo "$branches" | grep -xq "develop"; then has_develop="si"; fi
            echo "\"$repo\",\"$has_main\",\"$has_QA\",\"$has_develop\"" >> branches_report.csv
          done

          # Convertir CSV a XLSX
          csv2xlsx -o branches_report.xlsx branches_report.csv

      - name: Subir reporte XLSX como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: branches-report-xlsx
          path: branches_report.xlsx
