name: Generar reporte de repos + ramas importantes

on:
  workflow_dispatch:

jobs:
  list:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.PAT_TOKEN }}
      LONG_LIVED_BRANCHES: "main QA develop"
    steps:
      - name: Obtener todos los repositorios
        run: |
          curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/user/repos?per_page=100" > repos.json

      - name: Iniciar CSV
        run: |
          echo "repo,main,QA,develop" > branches_report.csv

      - name: Verificar ramas por repo y llenar CSV
        run: |
          for repo in $(jq -r '.[].full_name' repos.json); do
            branches=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$repo/branches?per_page=100" \
              | jq -r '.[].name')
            # definir valores por defecto vacíos
            has_main=""
            has_QA=""
            has_develop=""
            if echo "$branches" | grep -xq "main"; then has_main="yes"; fi
            if echo "$branches" | grep -xq "QA"; then has_QA="yes"; fi
            if echo "$branches" | grep -xq "develop"; then has_develop="yes"; fi
            # escribir línea en CSV
            echo "\"$repo\",\"$has_main\",\"$has_QA\",\"$has_develop\"" >> branches_report.csv
          done

      - name: Subir reporte como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: branches-report
          path: branches_report.csv
