name: Listar repos de mi cuenta + ramas importantes

on:
  workflow_dispatch:

jobs:
  list:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.PAT_TOKEN }}
      LONG_LIVED_BRANCHES: "main QA develop"
    steps:
      - name: Obtener todos los repositorios
        run: |
          curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/user/repos?per_page=100" > repos.json
          echo "üì¶ REPOSITORIOS ENCONTRADOS:"
          cat repos.json | jq -r '.[] | .full_name'

      - name: Verificar ramas ‚Äúde vida larga‚Äù en cada repo
        run: |
          echo "=== Verificando ramas importantes por repositorio ==="
          for repo in $(jq -r '.[].full_name' repos.json); do
            echo ""
            echo "Repositorio: $repo"
            # Obtener la lista de ramas
            branches=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$repo/branches?per_page=100" \
              | jq -r '.[].name')
            
            # Para cada rama de vida larga esperada, revisa si existe
            missing=()
            present=()
            for b in $LONG_LIVED_BRANCHES; do
              if echo "$branches" | grep -xq "$b"; then
                present+=("$b")
              else
                missing+=("$b")
              fi
            done
            
            if [ ${#present[@]} -gt 0 ]; then
              echo "  ‚úÖ Tiene ramas esperadas: ${present[*]}"
            fi
            if [ ${#missing[@]} -gt 0 ]; then
              echo "  ‚ö†Ô∏è Faltan ramas: ${missing[*]}"
            fi
          done
