name: Listar ramas de todos los repos

on:
  workflow_dispatch:

jobs:
  listar-ramas:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout vac√≠o
        uses: actions/checkout@v4

      - name: Listar organizaciones y sus repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üè¢ Obteniendo organizaciones del usuario..."
          orgs=$(gh api user/memberships/orgs --jq '.[].organization.login')

          echo "-----------------------------------------"
          echo "üìå Organizaciones encontradas:"
          echo "$orgs"
          echo "-----------------------------------------"

          for org in $orgs; do
            echo "üèõ ORGANIZACI√ìN: $org"
            echo "Repositorios en $org:"
            echo "-----------------------------------------"

            org_repos=$(gh repo list $org --limit 300 --json name --jq '.[].name')

            if [ -z "$org_repos" ]; then
              echo "‚ö†Ô∏è No se encontraron repos en esta organizaci√≥n."
            else
              echo "$org_repos"
            fi

            echo "========================================="
          done

      - name: Listar repos y ramas del usuario
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Obteniendo lista de repositorios del usuario..."

          # Obtener todos los repositorios del usuario
          repos=$(gh repo list ReneML12 --limit 200 --json name --jq '.[].name')

          echo "üìå Repos encontrados del usuario:"
          echo "$repos"
          echo "-----------------------------------------"

          # Recorrer todos los repositorios
          for repo in $repos; do
            echo "üìÅ REPO: $repo"
            echo "-----------------------------------------"

            # Obtener ramas del repo
            branches=$(gh api repos/ReneML12/$repo/branches --jq '.[].name')

            # Validar si tiene ramas
            if [ -z "$branches" ]; then
              echo "‚ö†Ô∏è No se encontraron ramas en $repo"
            else
              echo "üåø Ramas encontradas en $repo:"
              for branch in $branches; do
                # Obtener informaci√≥n detallada de cada rama
                last_commit=$(gh api repos/ReneML12/$repo/branches/$branch --jq '.commit.sha')
                last_date=$(gh api repos/ReneML12/$repo/commits/$last_commit --jq '.commit.author.date')

                echo " - Rama: $branch"
                echo "   √öltimo commit: $last_commit"
                echo "   Fecha del √∫ltimo commit: $last_date"
              done
            fi

            echo "========================================="
          done
